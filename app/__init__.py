from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from werkzeug.security import generate_password_hash
from datetime import datetime

db = SQLAlchemy()
login_manager = LoginManager()


def create_app():
    app = Flask(__name__)
    app.config['SECRET_KEY'] = 'super_secret_key_123'
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///../instance/app.db'
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

    db.init_app(app)
    login_manager.init_app(app)
    login_manager.login_view = 'login'

    from app.routes import main_bp
    app.register_blueprint(main_bp)

    from app.models import User, Vacancy, News

    # === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ë–î, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –¥–∞–Ω–Ω—ã—Ö ===
    with app.app_context():
        db.create_all()

        # --- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ---
        admin_user = User.query.filter_by(username='admin').first()
        if not admin_user:
            admin = User(
                username='admin',
                email='admin@mail.ru',
                password=generate_password_hash('admin123'),
                role='admin'
            )
            db.session.add(admin)
            print('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω: –ª–æ–≥–∏–Ω=admin, –ø–∞—Ä–æ–ª—å=admin123')

        # --- –ù–æ–≤–æ—Å—Ç–∏ ---
        if News.query.count() == 0:
            demo_news = [
                News(
                    title="–í–µ—Å–µ–Ω–Ω—è—è —è—Ä–º–∞—Ä–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π 2025",
                    short_text="–í –ú–æ—Å–∫–≤–µ –ø—Ä–æ—à–ª–∞ –µ–∂–µ–≥–æ–¥–Ω–∞—è —è—Ä–º–∞—Ä–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤.",
                    full_text="–ù–∞ –í–î–ù–• –±–æ–ª–µ–µ 200 —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∏ —Å–≤–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –º–æ–ª–æ–¥—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤. –°–ª—É–∂–±–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é.",
                    image="news1.jpg",
                    date=datetime(2025, 4, 15)
                ),
                News(
                    title="–ó–∞–ø—É—Å–∫ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–∞ ¬´–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏¬ª",
                    short_text="–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã–º IT-–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º –¥–ª—è –≤—Å–µ—Ö –∂–µ–ª–∞—é—â–∏—Ö.",
                    full_text="–°–æ–≤–º–µ—Å—Ç–Ω–æ —Å –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ–º —Ç—Ä—É–¥–∞ –æ—Ç–∫—Ä—ã—Ç –∫—É—Ä—Å –ø–æ —Ü–∏—Ñ—Ä–æ–≤—ã–º –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º. –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –æ–±—É—á–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.",
                    image="news2.jpg",
                    date=datetime(2025, 3, 27)
                ),
                News(
                    title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑—Ä–∞–±–æ—Ç–Ω—ã—Ö –≥—Ä–∞–∂–¥–∞–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–∞",
                    short_text="–ü–æ–≤—ã—à–µ–Ω–æ –ø–æ—Å–æ–±–∏–µ –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω, –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–ª—É–∂–±—ã –∑–∞–Ω—è—Ç–æ—Å—Ç–∏.",
                    full_text="–° –º–∞—Ä—Ç–∞ 2025 –≥–æ–¥–∞ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ—Å–æ–±–∏–π –∏ —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –±–µ–∑—Ä–∞–±–æ—Ç–Ω—ã—Ö.",
                    image="news3.jpg",
                    date=datetime(2025, 3, 10)
                ),
                News(
                    title="–§–æ—Ä—É–º —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π —Å–æ–±—Ä–∞–ª –∫—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏",
                    short_text="–ù–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–∞–¥—Ä–æ–≤ –∏ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞ —Ç—Ä—É–¥–∞.",
                    full_text="–§–æ—Ä—É–º —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π –ø—Ä–æ—à—ë–ª –≤ –ö–∞–∑–∞–Ω–∏ –∏ –æ–±—ä–µ–¥–∏–Ω–∏–ª –±–æ–ª–µ–µ 300 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –°–ª—É–∂–±–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –ø—Ä–æ–µ–∫—Ç —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞ –≤–∞–∫–∞–Ω—Å–∏–π.",
                    image="news4.jpg",
                    date=datetime(2025, 2, 22)
                ),
                News(
                    title="–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–ª–æ–¥–µ–∂–∏",
                    short_text="–ù–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–ø—É—Å–∫–Ω–∏–∫–∞–º –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—Ç—É.",
                    full_text="–í —Ä–∞–º–∫–∞—Ö —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –º–æ–ª–æ–¥—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤ –∏ –ø–æ–º–æ—â—å –≤ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ.",
                    image="news5.jpg",
                    date=datetime(2025, 2, 5)
                ),
            ]
            db.session.add_all(demo_news)
            print("üì∞ –î–æ–±–∞–≤–ª–µ–Ω–æ 5 –Ω–æ–≤–æ—Å—Ç–µ–π")

        # --- –í–∞–∫–∞–Ω—Å–∏–∏ ---
        if Vacancy.query.count() == 0:
            demo_vacancies = [
                Vacancy(company="–û–û–û ¬´–ë–∏–∑–Ω–µ—Å –ü–ª—é—Å¬ª", position="–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º", city="–ú–æ—Å–∫–≤–∞", salary="75000 ‚ÇΩ", description="–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ª—É–≥, —Ä–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –≤–µ–¥–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏."),
                Vacancy(company="–ê–û ¬´–¢–µ—Ö–Ω–æ–õ–æ–≥–∏–∫–∞¬ª", position="–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–∞–º", city="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", salary="60000 ‚ÇΩ", description="–í–µ–¥–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤–æ–≥–æ —É—á—ë—Ç–∞, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –∏ –ø–æ–¥–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª–∞."),
                Vacancy(company="–û–û–û ¬´–ê–ª—å—Ñ–∞ –§–∏–Ω–∞–Ω—Å¬ª", position="–ë—É—Ö–≥–∞–ª—Ç–µ—Ä –ø–æ –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π –ø–ª–∞—Ç–µ", city="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥", salary="68000 ‚ÇΩ", description="–†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã, –Ω–∞–ª–æ–≥–∏, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –≤ –§–ù–°."),
                Vacancy(company="–ü–ê–û ¬´–ò–Ω—Ñ–æ–°–æ—Ñ—Ç¬ª", position="–ò–Ω–∂–µ–Ω–µ—Ä-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç", city="–ö–∞–∑–∞–Ω—å", salary="95000 ‚ÇΩ", description="–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –Ω–∞ Python –∏–ª–∏ C#."),
                Vacancy(company="–û–û–û ¬´–î–æ—Å—Ç–∞–≤–∫–∞ 24¬ª", position="–í–æ–¥–∏—Ç–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ B", city="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", salary="55000 ‚ÇΩ", description="–î–æ—Å—Ç–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å–ª—É–∂–µ–±–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å."),
            ]
            db.session.add_all(demo_vacancies)
            print("üíº –î–æ–±–∞–≤–ª–µ–Ω–æ 5 –≤–∞–∫–∞–Ω—Å–∏–π")

        db.session.commit()

    return app
